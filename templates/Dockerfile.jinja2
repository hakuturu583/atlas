# ========================================
# Auto-generated Dockerfile for VLA: {{ name }}
# DO NOT EDIT MANUALLY - Edit configs/vla/{{ name }}.yaml instead
# Generated from templates/Dockerfile.jinja2
# ========================================

FROM {{ base_image }}

WORKDIR /app

{% if install_python is defined and install_python %}
# Install Python {{ python_version }}
RUN apt-get update && apt-get install -y \
    python{{ python_version }} \
    python3-pip \
    && rm -rf /var/lib/apt/lists/* \
    && ln -s /usr/bin/python{{ python_version }} /usr/bin/python
{% endif %}

# Install system packages
{% if system_packages %}
RUN apt-get update && apt-get install -y \
{% for pkg in system_packages %}
    {{ pkg }} \
{% endfor %}
    && rm -rf /var/lib/apt/lists/*
{% endif %}

# Install Python dependencies
{% for dep_group, deps in dependencies.items() %}
# {{ dep_group }} dependencies
RUN pip{{ '3' if install_python else '' }} install --no-cache-dir \
{% for dep in deps %}
    {{ dep }}{{ ' \\' if not loop.last else '' }}
{% endfor %}

{% endfor %}

# Copy files
{% for path in copy_paths %}
COPY {{ path.src }} {{ path.dst }}
{% endfor %}

# Create Python package files
{% if touch_files %}
{% for file in touch_files %}
RUN touch {{ file }}
{% endfor %}
{% endif %}

{% if grpc_health_probe and grpc_health_probe.enabled %}
# Install gRPC health probe
RUN GRPC_HEALTH_PROBE_VERSION={{ grpc_health_probe.version }} && \
    wget -qO/bin/grpc_health_probe \
    https://github.com/grpc-ecosystem/grpc-health-probe/releases/download/${GRPC_HEALTH_PROBE_VERSION}/grpc_health_probe-linux-amd64 && \
    chmod +x /bin/grpc_health_probe
{% endif %}

# Set environment variables
{% for key, value in environment.items() %}
ENV {{ key }}={{ value }}
{% endfor %}

EXPOSE {{ port }}

CMD {{ cmd | tojson }}
