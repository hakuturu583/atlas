version: "3.8"

# オプショナル: AD Stack/VLAモデルサービス
# デプロイ時に -c docker-compose.stack.adstack.yml を追加して使用

services:
  # VLAモデルサービス（ダミー）
  ad-stack-dummy:
    image: localhost:5000/atlas-vla-dummy:latest
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: "2"
          memory: 4G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    networks:
      - atlas-network
    ports:
      - "50051:50051"
    environment:
      - VLA_MODEL=dummy
      - VLA_PORT=50051
      - VLA_MAX_WORKERS=10
    healthcheck:
      test: ["CMD", "/bin/grpc_health_probe", "-addr=:50051"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s

  # VLAモデルサービス（Alpamayo）
  ad-stack-alpamayo:
    image: localhost:5000/atlas-vla-alpamayo:latest
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: "8"
          memory: 16G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      placement:
        constraints:
          - node.labels.gpu==true
    networks:
      - atlas-network
    ports:
      - "50052:50051"
    environment:
      - VLA_MODEL=alpamayo
      - VLA_PORT=50051
      - VLA_MAX_WORKERS=10
      - HF_HOME=/app/.cache/huggingface
      - CUDA_VISIBLE_DEVICES=0
    volumes:
      - type: bind
        source: ${HOME}/.cache/huggingface
        target: /app/.cache/huggingface
        read_only: true
    healthcheck:
      test: ["CMD", "/bin/grpc_health_probe", "-addr=:50051"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 300s  # モデルのダウンロード・初期化に時間がかかるため

networks:
  atlas-network:
    external: true
    name: atlas_atlas-network
